# 单视图室内场景重建

## 一、题目要求

如何使用单张房间的二维图片让机器人快速重建空间的三维模型（粗糙但有形状的3D重建即可，不要求精度）

## 二、方法

### 单视图几何

根据题目要求只能使用单张图片进行三维重建，但不要求精度。单视图几何重建的方法可以通过影消点（像素平面）、影消线（像素平面）、摄像机内参K和平面法向量（三维空间）之间的关系进行三维重建。由于只有单张图片所以损失了比例关系，但符合题目要求，所以选择采用单视图几何方法进行三维重建。

## 三、原理

### 1、影消点与影消线

   - ==影消点==：3D空间中的平行线的交点称为无穷远点，==3D空间中的一组平行线在相机像素平面上的投影不保持平行性质(透视变换)所以会在像素平面存在一个交点==，该交点为==影消点（齐次坐标表示$\textcolor{Black}{v}$~∞~=[a,b,1]^T^~3×1~）==，即3D空间中无穷远点在像素平面的投影。

     <img src="D:\桌面\offer\校招\灵动方程\图片\影消点.jpg" alt="image-20200927095842317" style="zoom:60%;" />

   - ==影消线==：3D空间中的平行线的==无穷远点都会集中在一条无穷远线上==。3D空间中的==无穷远线在像素平面上的投影为像素平面无穷远线（$\textcolor{Black}{l} $~∞~= [a,b,c]^T^~3×1~）==。

     <img src="D:\桌面\offer\校招\灵动方程\图片\影消线投影.png" alt="image-20200927095842317" style="zoom:60%;" />

   - ==影消线与影消点示意==：

     

     

     <img src="D:\桌面\offer\校招\灵动方程\图片\影消线，影消点.jpg" alt="image-20200927095842317" style="zoom:60%;" />

     

### 2、像素平面影消点$v$~∞~和三维空间直线$d$的关系

<img src="D:\桌面\offer\校招\灵动方程\图片\点与直线.jpg" alt="image-20200927095842317" style="zoom:60%;" />

其中直线方向：$d=[a,b,c]$^T^

- ==①== $v=Kd$     ===>==    单位向量$d=\frac{K^{-1} v}{\left\|K^{-1} v\right\|}$ 

- 证明：根据相机模型，$sp=KP$  ，其中$P$~3×1~为三维空间坐标，$p$~3×1~为像素坐标（齐次），$s$为深度。

  $d$上的无穷远点表示为$x$~∞~ = $[a,b,c,0]$^T^，则 $v$=$K[I,0]$$x$~∞~ =$Kd$。

==这样像素平面的影消点和三维空间的直线产生了联系==。

### 3、像素平面影消线和三维空间中面的法向量的关系

<img src="D:\桌面\offer\校招\灵动方程\图片\法向量和影消线.jpg" alt="image-20200927095842317" style="zoom:60%;" />

- ==②== $n=K$^T^$l_{\text {$horiz$}}$

- 证明：==根据2中相机模型==，空间平面$π$中的点$P$~4×1~（齐次表示）投影到像素平面得到 $p$~3×1~ 与 $l_{\text {$horiz$}}$ 点积为0、空间平面$π$中的点$P$~4×1~（齐次表示）与平面$π$=$[a,b,c,d]$的积为0。

  即：$l_{\text {$horiz$}}$^T^$K[I,0]P=0$

  ​		$π$^T^$P=0$

  ​		其中$l_{\text {$horiz$}}$为3×1向量。

  ====>==    $l_{\text {$horiz$}}$^T^$K[I,0]$=$π$^T^

  ====>==    $K[I,0]$^T^$l_{\text {$horiz$}}$=$π$

  ====>==	$K$$l_{\text {$horiz$}}$=$n$                $π$前三维等于$n$

这样像素平面影消线和三维空间平面中的法向量产生了联系。

### 4、利用上述两种关系进行三维重建

<img src="D:\桌面\offer\校招\灵动方程\图片\两种关系.jpg" alt="image-20200927095842317" style="zoom:30%;" />

- ==前提：计算像素平面影消点与影消线==

  以其中一面的计算为例，其他面的计算同理：

  <img src="D:\桌面\offer\校招\灵动方程\图片\计算影消.jpg" alt="image-20200927095842317" style="zoom:30%;" />

  如上图，==（实际上计算多个影消点会更准确）==。

  ==计算影消点==：使用标注的$A1$~3×1~,$A2$~3×1~先计算线$P$和$P$^'^    ====>==   SVD（$\left[\begin{array}{lll}A1^T \\ A2^T  \end{array}\right]$），取 $V$最后一列即为 $P=[a,b,c]$^T^ ，同理得到$P'=[a',b',c']$^T^。

  接着SVD（$\left[\begin{array}{lll}P^T \\ P'^T  \end{array}\right]$）取$V$最后一列得到影消点$x1$(归一化操作)，同理得到影消点$x2$（归一化操作）。

  ==计算影消线==：SVD（$\left[\begin{array}{lll}x1^T \\ x2^T  \end{array}\right]$），取$V$最后一列得到影消线方程$L=[a,b,c]$，其他面同理计算出影消线，至此三个面的影消点与影消点计算完成。

  ==改进方法==：上述影消点和影消线的计算的前提是需要手动在像素平面标出每个平行线上的两个点来计算直线方程，使用直线方程计算影消点与影消线，这样的方法不够自动化。

  ==使用LSD线段检测和线段聚类方法可以实现全自动三维重建。本文没有具体实现这一步，但根据[影消点线的计算](https://blog.csdn.net/ydy1107/article/details/121355836)应该可以实现。==

  <img src="D:\桌面\offer\校招\灵动方程\图片\自动计算影消.jpg" alt="image-20200927095842317" style="zoom:60%;" />

  

- 因为室内重建，墙面与墙面，墙面与地面，墙面与墙顶一般为垂直情况，所以==我们可以使用面他们之间夹角为90度的性质并结合影消点和直线方向的的关系====①==  $d=\frac{K^{-1} v}{\left\|K^{-1} v\right\|}$ 得到一个关于摄像机内参$K$的约束。

  <img src="D:\桌面\offer\校招\灵动方程\图片\两组平行线夹角.png" alt="image-20200927095842317" style="zoom:60%;" />

  

- 此时我们得到方程：  $v$~1~^T^$w$ $v$~2~=0，$w=(KK$^T^)^-1^$=$$\left[\begin{array}{lll}\omega_1 & \omega_2 & \omega_4 \\ \omega_2 & \omega_3 & \omega_5 \\ \omega_4 & \omega_5 & \omega_6\end{array}\right]$

- $K=\left[\begin{array}{ccc}\alpha & -\alpha \cot \theta & c_x \\ 0 & \frac{\beta}{\sin \theta} & c_y \\ 0 & 0 & 1\end{array}\right]$，这里θ $=90$所以得到  $\omega_2=0$,且假设为方形像素得到  $\omega_1=\omega_3$，则$w$$=$$\left[\begin{array}{lll}\omega_1 & 0 & \omega_4 \\ 0 & \omega_1 & \omega_5 \\ \omega_4 & \omega_5 & \omega_6\end{array}\right]$，此时 $w$ 有3个自由度。我们把 $w$ 写成$\left[\begin{array}{lll}\omega_1 \\ \omega_4 \\ \omega_5\\ \omega_6\end{array}\right]$ 的形式便于后面进行SVD分解。

- ==这里求解w需要进行一些变化，需要将上式进行一些变化==：类似于使用八点法SVD分解求解F矩阵，将 $v$~1~^T^$w$ $v$~2~=0 写成$QW=0$的形式==对Q进行SVD分解==，这里==至少需要5对这样的点对得到至少3个约束方程==，$\left\{\begin{array}{l}v_1^T \omega v_2=0 \\ v_1^T \omega v_3=0 \\ v_2^T \omega v_3=0\end{array}\right.$   

- SVD($Q$~3×4~)后取奇异值最小值对应的V的一列即V的最后一列V[：，-1]~4×1~，4个元素分别为$w$~1~,$w$~4~,$w$~5~,$w$~6~，得到$w$矩阵$\left[\begin{array}{lll}\omega_1 & 0 & \omega_4 \\ 0 & \omega_1 & \omega_5 \\ \omega_4 & \omega_5 & \omega_6\end{array}\right]$

- 再将$w$进行==cholesky分解==得到$K$^-1^

- $K=$invers($K$^-1^)/$K[-1][-1]$

==到这里我们得到了摄像机的内参==$K$==。接下来我们使用内参==$K$==带入====②==   $n=K$^T^$l_{\text {$horiz$}}$ 得到平面法向量$n$。

<img src="D:\桌面\offer\校招\灵动方程\图片\重构.jpg" alt="image-20200927095842317" style="zoom:60%;" />



- -----------------------------------------------------------------------------------------------------

- 利用上面计算得到的摄像机内参$K$计算法向量

==★==像素平面的影消线 $l_{\text {$horiz$}}$ 已知，所以将使用====②==   $n=K$^T^$l_{\text {$horiz$}}$ 计算得到各个空间平面的法向量，但此时得到的$n$（归一化）为法向量维度为3×1，所以我们还需要计算一维距离。根据三个平面的交点$A=[a,b,1]$，我们计算可以计算得出距离d。这样我们就得出平面方程$π$=$[a,b,c,d]$。



证明：$A=[a,b,1]$^T^为$A$^'^=[a^'^,b^'^,c^'^]^T^在像素平面的投影，$P$^'^=[a^'^,b^'^,c^'^,1]^T^为$A$^'^的齐次表示， $π$=$[a,b,c,d]$

​			三个平面中任一平面：$π$×$P$^'^=0   ====>==    $n$^T^$A$^'^+d=0   

​			$A$^'^=$K$^-1^A	所以 ====>==  d=-$n$^T^$K$^-1^A  ，其中$A$是标定出来已知的，如下图所示：

<img src="D:\桌面\offer\校招\灵动方程\图片\三平面交点.jpg" alt="image-20200927095842317" style="zoom:60%;" />

- ==这样我们的三个面的方程已经求出，随后进行三维显示即可。==

==★====上述A点是需要手动标定的，但其实我们可以丢弃原图直接显示三维重建，那么我们就不需要手动标定三面的相交点，直接选定一个随机点作为交点即可重建，这省去了检测三维空间点的操作。==

## 四、重建效果

- 单视图

<img src="D:\桌面\offer\校招\灵动方程\图片\原图.jpg" alt="image-20200927095842317" style="zoom:100%;" />

- 重建效果

  <img src="D:\桌面\offer\校招\灵动方程\图片\动图.gif" alt="image-20200927095842317" style="zoom:100%;" />

# 简历项目-单应性举证计算与透视变换代码

因为换了电脑，所以原来的工程代码实在是找不到了，但是大致是如下两行代码的思路，另外附有PPT文件。

```
h, status = cv2.findHomography(pts_src, pts_dst, cv2.RANSAC)
im_dst = cv2.warpPerspective(im_src, h, size)
```

